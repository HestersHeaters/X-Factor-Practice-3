name: Restore & Smoke (macOS + Windows)

on:
  push:
  pull_request:

jobs:
  smoke:
    name: Restore & Smoke (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    env:
      CI: "true"
      GITHUB_ACTIONS: "true"
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Works before R is installed
      - name: Debug — list repo root and data/
        run: |
          echo "PWD:" && pwd
          echo "::group::ls -la"
          ls -la
          echo "::endgroup::"
          echo "::group::ls -la data"
          ls -la data || true
          echo "::endgroup::"

      - name: Setup R
        id: setup-r
        uses: r-lib/actions/setup-r@v2
        with:
          # If you know exact version in renv.lock, pin it here (e.g., 4.3.2)
          r-version: '4.3'

      - name: Setup pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-${{ steps.setup-r.outputs.installed-r-version }}-${{ hashFiles('renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-r-${{ steps.setup-r.outputs.installed-r-version }}-

      - name: Install renv
        run: Rscript -e "if(!requireNamespace('renv', quietly=TRUE)) install.packages('renv')"

      # Assert your three Excel files exist (catches path/name typos)
      - name: Debug — assert Excel files exist
        run: |
          Rscript -e 'cat("WD:", getwd(), "\n"); \
                      fs <- c("data/Team Data - X Factor Update.xlsx", \
                              "data/Hitter Data - X Factor Update.xlsx", \
                              "data/Pitcher Data - X Factor Update.xlsx"); \
                      print(setNames(file.exists(fs), fs)); \
                      if (!all(file.exists(fs))) { \
                        missing <- paste(fs[!file.exists(fs)], collapse = "\n  - "); \
                        stop(paste("Missing expected Excel files:\n  -", missing)) }'

      # Safe major.minor check without regex escaping issues
      - name: Assert renv.lock R matches CI R (major.minor)
        run: |
          Rscript -e 'if(!requireNamespace("jsonlite", quietly=TRUE)) install.packages("jsonlite"); \
                      j <- jsonlite::fromJSON("renv.lock"); lock <- j$R$Version; \
                      ci <- as.character(getRversion()); \
                      split <- function(x) strsplit(x, ".", fixed = TRUE)[[1]]; \
                      ci_mm <- paste(split(ci)[1],  split(ci)[2],  sep = "."); \
                      lk_mm <- paste(split(lock)[1], split(lock)[2], sep = "."); \
                      cat("CI R:", ci, "\nLockfile R:", lock, "\n"); \
                      if (ci_mm != lk_mm) stop(sprintf("R mismatch: CI %s vs lockfile %s", ci, lock))'

      - name: Bootstrap (restore + chromote)
        run: Rscript bootstrap.R

      - name: Session info
        run: Rscript -e "sessionInfo()"

      - name: Preflight
        run: Rscript preflight.R

      - name: Parse scripts
        run: |
          Rscript -e "tools::parse_R('Create X Factor Update Graphics.R')"
          Rscript -e "tools::parse_R('Render X Factor Update Graphics.R')"
