# mlb_x_factor_project — X‑Factor Update Graphics

MLB visuals (**teams / hitters / pitchers**) from Excel → **HTML + PNG**.  
Offline‑stable (local Quicksand font + local team logos). Deterministic rendering with optional drift baselines.

---

## Quick Start

```r
# one-time per machine
source("bootstrap.R")

# sanity checks (prints ✅ / ❌ with fixes)
source("preflight.R")

# normal usage (interactive menus)
source("render_x_factor_update_graphics.R")
```

---

## What Changed (Original → Current)

- **Unified, parameterized builders**: one engine handles any league/division/sheet.
- **Menu‑driven runner**: `render_x_factor_update_graphics.R` orchestrates kind, scope, sheet, and baselines.
- **Deterministic session**: fixed seed/locale/time zone → identical visuals.
- **Reproducible env**: `renv.lock` + `.Rprofile` auto‑activation.
- **Baseline integrity**: per‑sheet HTML hash baselines with enforce / write‑update prompts.
- **Robust rendering**: detects `chromote`/`webshot2`, timeouts, PNG canvas normalization, inner keyline.
- **Offline‑ready assets**: local MLB logos; local Quicksand embedding (Google Fonts fallback).
- **Cleaner visuals**: consistent headers, logo column labels, heat fills, legends, ellipsis for long names.
- **Safer I/O**: explicit Excel inputs under `data/`; consistent outputs under `outputs/…`.
- **Maintainable design**: modular functions, clearer naming, better errors.
- **Diff tooling**: narrative + side‑by‑side diffs under `build/diff/`.

For narrative diffs, open `build/diff/INDEX.md`.

---

## Project Structure

```
create_x_factor_update_graphics.R         # core engines + run_with_excel()
render_x_factor_update_graphics.R         # interactive runner (menus + baselines)
bootstrap.R                               # one-time setup (renv restore, backend hints, preflight)
preflight.R                               # local checks & actionable guidance
mlb_x_factor_project.Rproj                # RStudio project
.Rprofile                                 # auto-activates renv
renv.lock
renv/
├─ activate.R
└─ settings.json

build/
└─ baselines/
   └─ baseline_<kind>_<league>_<division>_<period>.txt
      # e.g., baseline_teams_al_w_july_2025.txt

assets/
├─ mlb/
│  └─ <team>.png          # e.g., ari.png, wsh.png
└─ quicksand_font/
   ├─ Quicksand-Regular.woff2 / .ttf
   ├─ Quicksand-Bold.woff2    / .ttf
   └─ Quicksand-VariableFont_wght.ttf  # optional

data/
├─ team_data_x_factor_update.xlsx
├─ hitter_data_x_factor_update.xlsx
└─ pitcher_data_x_factor_update.xlsx

tools/
├─ diff_portfolio_plus.R
└─ (optional) migrate_baselines_slug.R

build/diff/                          # generated by make_diffs.R
outputs/                              # rendered PNG/HTML (git-ignored)

.github/
└─ workflows/
   └─ (optional) CI workflows
```

---

## Requirements

- **R** 4.3.x (lockfile built on 4.3; 4.3 is recommended)
- **Packages** (managed via `renv::restore()`):
  - Core: `dplyr`, `purrr`, `tidyr`, `gt`, `readxl`, `glue`, `withr`, `R.utils`, `magick`, `rlang`, `digest`
  - Optional: `base64enc` (offline font embedding)
- **PNG backend** (one of):
  - **Recommended:** `chromote` (+ local Chrome/Chromium)
  - Alternative: `webshot2` (PhantomJS optional)

On macOS, CLT may be required for source builds:
```bash
xcode-select --install
```

---

## Setup

`.Rprofile` auto‑activates `renv` in this project.

```r
# one-time per machine
source("bootstrap.R")  # restores packages, ensures backend, runs preflight
```

Manual (if preferred):
```r
install.packages("renv")
if (file.exists("renv/activate.R")) source("renv/activate.R")
renv::restore()
install.packages("chromote")  # or webshot2; if webshot2 then webshot2::install_phantomjs()
source("preflight.R")
```

---

## Running

### Interactive (menus + sheet prompt + baselines)
```r
source("render_x_factor_update_graphics.R")
```
You’ll choose:
- **Kind**: teams / hitters / pitchers / ALL
- **Scope**: single division or all AL/NL × W/E/C
- **Sheet**: prompted every run
- **Baselines**: enforce and/or write per kind/league/division/sheet

**Outputs**
```
outputs/<kind>/<kind>_<period>/
  <league>_<division>_<kind>_<period>.html
  <league>_<division>_<kind>_<period>.png
```
Examples:
```
outputs/teams/teams_july_2025/al_w_teams_july_2025.png
outputs/hitters/hitters_eos_2025/nl_c_hitters_eos_2025.html
```

Where:
- `<league>` is `al|nl`
- `<division>` is `w|e|c`
- `<period>` is a slug of the sheet name
  - `"End of Season 2025"` → `eos_2025`
  - `"July 2025"` → `july_2025`

### Direct call (non‑interactive)
```r
source("create_x_factor_update_graphics.R")
run_with_excel(
  input_xlsx  = "data/team_data_x_factor_update.xlsx",
  sheet       = "July 2025",
  league      = "AL", division = "W",
  kind        = "teams",
  output_png  = "outputs/teams/teams_july_2025/al_w_teams_july_2025.png",
  output_html = "outputs/teams/teams_july_2025/al_w_teams_july_2025.html",
  baseline    = NA_character_  # or a path from build/baselines/...
)
```

---

## Baselines (Drift Detection)

Baselines live under `build/baselines/` and are **per kind × league × division × sheet**:

```
baseline_<kind>_<league>_<division>_<period>.txt
# e.g., baseline_teams_al_w_july_2025.txt
```

- **Read (back‑compat)**: the runner can find legacy uppercase and older naming patterns.
- **Write (canonical)**: filenames are always lower_snake_case.
- **One‑shot fixer** (if you need to normalize existing files):
  ```r
  normalize_baselines_now <- function(dir = "build/baselines") {
    if (!dir.exists(dir)) stop("Baselines dir not found: ", dir)
    files <- list.files(dir, pattern = "^baseline_.*\.txt$", full.names = TRUE)
    for (f in files) {
      bn <- basename(f)
      bn_new <- tolower(bn)
      bn_new <- gsub("_+", "_", bn_new)
      bn_new <- gsub("^_|_$", "", bn_new)
      if (!identical(bn_new, bn)) file.rename(f, file.path(dirname(f), bn_new))
    }
    invisible(TRUE)
  }
  # normalize_baselines_now("build/baselines")
  ```

---

## Fonts & Logos

- **Team logos**: looks for `assets/mlb/*.png` first; falls back to ESPN CDN if missing.
- **Quicksand font**: if `assets/quicksand_font/` is present *and* `base64enc` is installed, the font is embedded for offline HTML. Otherwise the Google Font is used.

---

## Diffs (Changelog)

```r
source("make_diffs.R")  # generates build/diff/teams|hitters|pitchers_changelog.md + HTML
```
Open `build/diff/INDEX.md` for links to Markdown and side‑by‑side HTML diffs.

---

## Troubleshooting

- **No PNG backend**: install `chromote` (preferred) or `webshot2` (optionally `webshot2::install_phantomjs()`).
- **Baseline drift error**: if intentional, update baseline via the runner; otherwise investigate data/assets/version changes.
- **macOS build errors**: install CLT with `xcode-select --install`.
- **Missing inputs**: place the three Excel files under `data/` using the exact snake_case names above.

---

## License

See [LICENSE](./LICENSE).
